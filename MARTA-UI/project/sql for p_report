CREATE VIEW passenger_in_out AS
SELECT station, p_in, p_out, sumfare, StartTime
FROM passenger_in
NATURAL LEFT JOIN
passenger_out



CREATE VIEW A AS
SELECT StartsAt AS station, SUM(Tripfare) AS sumfare, COUNT(StartTime) AS p_in
FROM Trip
WHERE StartTime >= start_time AND StartTime <= end_time
GROUP BY 
station

CREATE VIEW B AS
SELECT EndsAt AS station, COUNT(StartTime) AS p_out
FROM Trip
WHERE StartTime >= start_time AND StartTime <= end_time
GROUP BY
station

CREATE VIEW AB AS
SELECT station, p_in, p_out, sumfare
FROM A
NATURAL LEFT JOIN
B

CREATE VIEW BA AS
SELECT station, p_in, p_out, sumfare
FROM A
NATURAL RIGHT JOIN
B

CREATE VIEW ABUBA AS
SELECT *
FROM AB
UNION
SELECT *
FROM BA

CREATE VIEW flow_report AS
SELECT Station.name AS Name, IFNULL(sumfare, 0) AS revenue, 
IFNULL(p_in, 0) AS passenger_in, 
IFNULL(p_out, 0) AS passenger_out, IFNULL(IFNULL(p_in, 0)-IFNULL(p_out, 0), 0) AS flow
FROM
ABUBA
INNER JOIN
Station
on ABUBA.station = Station.stopID



SELECT Station.name AS Name, IFNULL(sumfare, 0) AS revenue, 
IFNULL(p_in, 0) AS passenger_in, 
IFNULL(p_out, 0) AS passenger_out, IFNULL(IFNULL(p_in, 0)-IFNULL(p_out, 0), 0) AS flow
FROM(
SELECT station, p_in, p_out, sumfare
FROM
(SELECT StartsAt AS station, SUM(Tripfare) AS sumfare, COUNT(BreezecardNum) AS p_in
FROM Trip
GROUP BY 
station) 
AS A
NATURAL LEFT JOIN
(SELECT EndsAt AS station, COUNT(BreezecardNum) AS p_out
FROM Trip
GROUP BY
station)
AS B
UNION
SELECT station, p_in, p_out, sumfare
FROM
(SELECT StartsAt AS station, SUM(Tripfare) AS sumfare, COUNT(BreezecardNum) AS p_in
FROM Trip
GROUP BY 
station) 
AS A
NATURAL RIGHT JOIN
(SELECT EndsAt AS station, COUNT(BreezecardNum) AS p_out
FROM Trip
GROUP BY
station)
AS B) AS C
INNER JOIN
Station
ON C.station = Station.stopID


SELECT station, IFNULL( sumfare, 0 ) AS revenue, IFNULL( p_in, 0 ) AS passenger_in, IFNULL( p_out, 0 ) AS passenger_out, IFNULL( IFNULL( p_in, 0 ) - IFNULL( p_out, 0 ) , 0 ) AS flow
FROM (

SELECT StartsAt AS station, SUM( Tripfare ) AS sumfare, COUNT( StartsAt ) AS p_in
FROM Trip
GROUP BY station
) AS A
NATURAL LEFT JOIN (

SELECT EndsAt AS station, COUNT( EndsAt ) AS p_out
FROM Trip
GROUP BY station
) AS B
UNION 
SELECT station, IFNULL( sumfare, 0 ) AS revenue, IFNULL( p_in, 0 ) AS passenger_in, IFNULL( p_out, 0 ) AS passenger_out, IFNULL( IFNULL( p_in, 0 ) - IFNULL( p_out, 0 ) , 0 ) AS flow
FROM (

SELECT StartsAt AS station, SUM( Tripfare ) AS sumfare, COUNT( StartsAt ) AS p_in
FROM Trip
GROUP BY station
) AS A
NATURAL RIGHT JOIN (

SELECT EndsAt AS station, COUNT( EndsAt ) AS p_out
FROM Trip
GROUP BY station
) AS B

SELECT Station.name AS Name, IFNULL(sumfare, 0) AS revenue, 
IFNULL(p_in, 0) AS passenger_in, 
IFNULL(p_out, 0) AS passenger_out, IFNULL(IFNULL(p_in, 0)-IFNULL(p_out, 0), 0) AS flow
FROM(
SELECT station, p_in, p_out, sumfare
FROM
(SELECT StartsAt AS station, SUM(Tripfare) AS sumfare, COUNT(BreezecardNum) AS p_in
FROM Trip
GROUP BY 
station) 
AS A
NATURAL LEFT JOIN
(SELECT EndsAt AS station, COUNT(BreezecardNum) AS p_out
FROM Trip
GROUP BY
station)
AS B
UNION
SELECT station, p_in, p_out, sumfare
FROM
(SELECT StartsAt AS station, SUM(Tripfare) AS sumfare, COUNT(BreezecardNum) AS p_in
FROM Trip
GROUP BY 
station) 
AS A
NATURAL RIGHT JOIN
(SELECT EndsAt AS station, COUNT(BreezecardNum) AS p_out
FROM Trip
GROUP BY
station)
AS B) AS C
INNER JOIN
Station
ON C.station = Station.stopID




SELECT *
FROM
(SELECT StartsAt AS station, SUM(Tripfare) AS sumfare, COUNT(StartsAt) AS p_in
FROM Trip
GROUP BY 
station) 
AS A
NATURAL LEFT JOIN
(SELECT EndsAt AS station, COUNT(EndsAt) AS p_out
FROM Trip
GROUP BY
station)
AS B
UNION
SELECT *
FROM
(SELECT StartsAt AS station, SUM(Tripfare) AS sumfare, COUNT(StartsAt) AS p_in
FROM Trip
GROUP BY 
station) 
AS A
NATURAL RIGHT JOIN
(SELECT EndsAt AS station, COUNT(EndsAt) AS p_out
FROM Trip
GROUP BY
station)
AS B


(SELECT StartsAt AS Station, SUM(Tripfare) AS sumfare, COUNT(StartsAt) AS p_in
FROM Trip
GROUP BY 
StartsAt 
AS A
LEFT JOIN
SELECT EndsAt AS station, COUNT(EndsAt) AS p_out
FROM Trip
GROUP BY
EndsAt
AS B
ON A.station = B.station)
UNION
(SELECT StartsAt, SUM(Tripfare) AS sumfare, COUNT(StartsAt) AS p_in
FROM Trip
GROUP BY 
StartsAt 
AS A
RIGHT JOIN
SELECT EndsAt AS station, COUNT(EndsAt) AS p_out
FROM Trip
GROUP BY
EndsAt
AS B
ON A.StartsAt=B.station)




SELECT StartsAt, SUM(Tripfare), COUNT(StartsAt)
FROM Trip
GROUP BY StartsAt

SELECT A.StartsAt, A.p_in, B.p_out, A.total_fare
FROM
(SELECT a.StartsAt, a.COUNT(a.StartsAt) as p_in, SUM(a.Tripfare) as total_fare
FROM Trip a
GROUP BY a.StartsAt) AS A
UNION 
(SELECT b.EndsAt, b.COUNT(b.EndsAt) as p_out, SUM(b.Tripfare)
FROM Trip b
GROUP BY a.StartsAt) AS B
ON A.StartsAt = B.EndsAt


SELECT A.StartsAt, A.pin, B.pout, A.pin-B.pout, A.sumfare
FROM
(SELECT StartsAt, SUM(Tripfare) AS sumfare, COUNT(StartsAt) AS pin
FROM Trip
GROUP BY 
StartsAt)AS A
LEFT JOIN B
ON A.StartsAt = B.EndsAt
UNION
(SELECT EndsAt, COUNT(EndsAt) AS pout
FROM Trip
GROUP BY
EndsAt) AS B
RIGHT JOIN A
ON A.StartsAt = B.EndsAt

SELECT A.StartsAt, A.pin, A.sumfare
FROM
(SELECT StartsAt, SUM(Tripfare) AS sumfare, COUNT(StartsAt) AS pin
FROM Trip
GROUP BY 
StartsAt)AS A

SELECT B.EndsAt, B.pout
FROM (
SELECT EndsAt, COUNT( EndsAt ) AS pout
FROM Trip
GROUP BY EndsAt
) AS B

SELECT A.StartsAt, A.pin, B.pout, A.pin-B.pout, A.sumfare
FROM
(SELECT StartsAt, SUM(Tripfare) AS sumfare, COUNT(StartsAt) AS pin
FROM Trip
GROUP BY 
StartsAt)AS Aï¼Œ
(SELECT EndsAt, COUNT(EndsAt) AS pout
FROM Trip
GROUP BY
EndsAt) AS B,
(A LEFT JOIN B
ON A.StartsAt = B.EndsAt
UNION
B RIGHT JOIN A
ON A.StartsAt = B.EndsAt)



SELECT A.StartsAt, A.pin, B.pout, A.pin-B.pout, A.sumfare
FROM
(SELECT StartsAt, SUM(Tripfare) AS sumfare, COUNT(StartsAt) AS pin
FROM Trip
GROUP BY 
StartsAt)AS A
LEFT JOIN
(SELECT EndsAt, COUNT(EndsAt) AS pout
FROM Trip
GROUP BY
EndsAt
) AS B
ON A.StartsAt = B.EndsAt
UNION
(SELECT StartsAt, SUM(Tripfare) AS sumfare, COUNT(StartsAt) AS pin
FROM Trip
GROUP BY 
StartsAt)AS A
RIGHT JOIN
(SELECT EndsAt, COUNT(EndsAt) AS pout
FROM Trip
GROUP BY
EndsAt
) AS B
ON A.StartsAt = B.EndsAt


SELECT A.StartsAt, A.pin, B.pout, A.pin-B.pout, A.sumfare
FROM
(SELECT StartsAt, SUM(Tripfare) AS sumfare, COUNT(StartsAt) AS pin
FROM Trip
GROUP BY 
StartsAt)AS A
CROSS JOIN
(SELECT EndsAt, COUNT(EndsAt) AS pout
FROM Trip
GROUP BY
EndsAt
) AS B



(SELECT StartsAt, SUM(Tripfare) AS sumfare, COUNT(StartsAt) AS p_in
FROM Trip
GROUP BY 
StartsAt 
AS A
LEFT JOIN
SELECT EndsAt AS station, COUNT(EndsAt) AS p_out
FROM Trip
GROUP BY
EndsAt
AS B
ON A.StartsAt = B.station)
UNION
(SELECT StartsAt, SUM(Tripfare) AS sumfare, COUNT(StartsAt) AS p_in
FROM Trip
GROUP BY 
StartsAt 
AS A
RIGHT JOIN
SELECT EndsAt AS station, COUNT(EndsAt) AS p_out
FROM Trip
GROUP BY
EndsAt
AS B
ON A.StartsAt=B.station)

(SELECT a.StartsAt, COUNT(StartsAt)
FROM Trip a
GROUP BY a.StartsAt)
UNION 
(SELECT b.EndsAt, COUNT(EndsAt)
FROM Trip b
GROUP BY b.EndsAt)


SELECT a.StartsAt, a.COUNT(a.StartsAt) as p_in, SUM(a.Tripfare) as total_fare
FROM Trip a
GROUP BY a.StartsAt) AS A
UNION 
(SELECT b.EndsAt, b.COUNT(b.EndsAt) as p_out, SUM(b.Tripfare)
FROM Trip b
GROUP BY a.StartsAt) AS B
ON A.StartsAt = B.EndsAt



SELECT A.station
FROM
(SELECT a.StartsAt as station
FROM Trip a
GROUP BY a.StartsAt) AS A
UNION 
(SELECT b.EndsAt AS station
FROM Trip b
GROUP BY b.station) AS B

